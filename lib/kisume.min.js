/*!
 * Kisume 0.4.1
 * Cross-sandbox-window utility library for userscript environments
 * https://github.com/smilekzs/kisume
*/
!function(){var COFFEE_RUNTIME,KISUME_BOTTOM,Kisume,bailout,closure,quote,san_func,strings,unique,_class,_ref,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__slice=[].slice,__hasProp={}.hasOwnProperty;closure=function(script){return"(function(ENV){"+script+"})(KISUME.ENV);"},quote=function(s){return JSON.stringify(s)},unique=function(a){var last,x,_i,_len,_results;for(_results=[],_i=0,_len=a.length;_len>_i;_i++)x=a[_i],x!==last&&_results.push(last=x);return _results},strings=function(a){var s,x,_i,_len,_results;for(_results=[],_i=0,_len=a.length;_len>_i;_i++)x=a[_i],(s=null!=x?x.toString():void 0)&&_results.push(s);return _results},san_func=function(f){return f instanceof Function?f:function(){}},bailout=function(cb,err){throw"function"==typeof cb&&cb(err),err},Kisume=function(){function Kisume(){return this._listener=__bind(this._listener,this),_ref=_class.apply(this,arguments)}var _run;return Kisume.prototype.VERSION="0.4.1",_class=function(){var _;return _=function(W,opt,cb){var script;return this instanceof Kisume?((null!=W?W.top:void 0)instanceof Window||bailout(cb,Error("Kisume: must be initialized on Window instance")),this.options=opt||{},this._W=W,this._D=W.document,this._tran={},this._init_cb=san_func(cb),this._D.head.dataset.kisume?bailout(cb,Error("Kisume: already initialized on this window")):(this._W.addEventListener("message",this._listener),script="("+KISUME_BOTTOM+")();",script=this.options.coffee?""+COFFEE_RUNTIME+";(function(){"+script+";})();":"(function(){"+COFFEE_RUNTIME+";"+script+";})();",this.inject(script),this._D.head.dataset.kisume=this.VERSION)):new Kisume(W,opt,cb)},function(){var W,x;switch(W=arguments[0],x=2<=arguments.length?__slice.call(arguments,1):[],x.length){case 0:case 1:return _.call.apply(_,[this,W,{}].concat(__slice.call(x)));case 2:return _.apply(this,arguments)}}}(),Kisume.prototype.inject=function(script){var el;return el=this._D.createElement("script"),el.textContent=script,this._D.head.appendChild(el)},Kisume.prototype.set=function(ns,includes,o,cb){var f,i,name,q,v,x,_i,_len;f="",v=[];for(name in o)if(__hasProp.call(o,name))switch(x=o[name],!1){case!(x instanceof Function):f+=""+ns+"["+quote(name)+"] = ("+x+");\n";break;case!(x instanceof Node):break;default:v.push({name:name,value:x})}if(f){for(includes=unique((includes||[]).concat(ns).sort()),q="",_i=0,_len=includes.length;_len>_i;_i++)i=includes[_i],q+="var "+i+" = ENV("+quote(i)+");\n";this.inject(closure(""+q+";"+f+";"))}return this._Q_dn(cb,{type:"set",ns:ns,v:v})},Kisume.prototype.get=function(ns,names,cb){return names=strings(names),this._Q_dn(cb,{type:"get",ns:ns,names:names})},_run=function(async){var _bound,_iife;return _iife=function(){var args,cb,f,n,_i;return f=arguments[0],args=3<=arguments.length?__slice.call(arguments,1,_i=arguments.length-1):(_i=1,[]),cb=arguments[_i++],n=this._Q_dn(),this.inject(closure("KISUME.iife["+n+"] = ("+f+");")),this._Q_dn(cb,{type:"run",async:async,iife:n,args:args})},_bound=function(){var args,cb,name,ns,_i;return ns=arguments[0],name=arguments[1],args=4<=arguments.length?__slice.call(arguments,2,_i=arguments.length-1):(_i=2,[]),cb=arguments[_i++],this._Q_dn(cb,{type:"run",async:async,ns:ns,name:name,args:args})},function(){var x,xs;return x=arguments[0],xs=2<=arguments.length?__slice.call(arguments,1):[],function(){switch(typeof x){case"function":return _iife;case"string":return _bound;default:return function(){}}}().apply(this,arguments)}},Kisume.prototype.run=_run(!1),Kisume.prototype.runAsync=_run(!0),Kisume.prototype._Q_dn=function(){var n;return n=0,function(cb,o){return++n,cb&&(this._tran[n]=san_func(cb)),null!=o&&(o._kisume_Q_dn=n,this._W.postMessage(o,this._W.location.origin)),n}}(),Kisume.prototype._A_up=function(n,o){var cb;switch(cb=this._tran[n],o.type){case"init":this._init_cb.call(this);break;case"set":case"get":case"run":o.async?cb.apply(null,[o.err].concat(__slice.call(o.rets))):cb(o.err,o.ret)}return delete this._tran[n]},Kisume.prototype._listener=function(e){var n,o;if(e.origin===window.location.origin&&null!=(o=e.data))switch(!1){case null==(n=o._kisume_A_up):return this._A_up(n,o)}},Kisume}(),KISUME_BOTTOM=function(){/*! Kisume 0.4.1*/
var KISUME;if(null==window.KISUME)return window.KISUME=KISUME=new(function(){function _Class(){var _this=this;this.iife={},this._tran={},this._ENV={},this.ENV=function(x){var ns,_base;return(ns=null!=x?x.toString():void 0)?(_base=_this._ENV)[ns]||(_base[ns]={}):_this._ENV}}return _Class.prototype.VERSION="0.4.1",_Class.prototype.TRACE="true",_Class.prototype._err=function(e){switch(!1){case!(e instanceof Error):return function(){var message,name,stack;return name=e.name,message=e.message,stack=e.stack,{name:name,message:message,stack:stack}}();case null==e:return e;default:return!0}},_Class.prototype._A_up=function(n,o){o._kisume_A_up=n,window.postMessage(o,window.location.origin)},_Class.prototype._Q_dn=function(n,o){var e,f,name,ret,t,value,x,_i,_j,_len,_len1,_ref1,_ref2,_ref3,_this=this;try{switch(o.type){case"set":for(x=this.ENV(o.ns),_ref1=o.v,_i=0,_len=_ref1.length;_len>_i;_i++)_ref2=_ref1[_i],name=_ref2.name,value=_ref2.value,x[name]=value;this._A_up(n,{type:"set"});break;case"get":for(x=this.ENV(o.ns),ret={},_ref3=o.names,_j=0,_len1=_ref3.length;_len1>_j;_j++)name=_ref3[_j],ret[name]=function(v){switch(!1){case!(v instanceof Function):return v.toString();case!(v instanceof Node):return"Node";case!(v instanceof Error):return this._err(v);default:return v}}(x[name]);this._A_up(n,{type:"get",ret:ret});break;case"run":null!=o.iife?(f=this.iife[o.iife],t=this._ENV):(f=this.ENV(o.ns)[o.name],t=this.ENV(o.ns)),f instanceof Function?o.async?f.call.apply(f,[t].concat(__slice.call(o.args),[function(){var err,rets;return err=arguments[0],rets=2<=arguments.length?__slice.call(arguments,1):[],_this._A_up(n,{type:"run",async:!0,err:err,rets:rets})}])):(ret=f.apply(t,o.args),this._A_up(n,{type:"run",async:!1,ret:ret})):this._A_up(n,{type:"run",err:"KISUME: function not found"})}}catch(_error){e=_error,this._A_up(n,{type:o.type,async:!1,err:this._err(e)})}},_Class}()),window.addEventListener("message",function(e){var n,o;if(e.origin===window.location.origin&&null!=(o=e.data))switch("true"===KISUME.TRACE&&(null!=o.err?console.warn(o):console.info(o)),!1){case null==(n=o._kisume_Q_dn):return KISUME._Q_dn(n,o)}}),KISUME._A_up(0,{type:"init"})},function(exports){return exports.Kisume=Kisume}("undefined"!=typeof exports&&null!==exports?exports:this),COFFEE_RUNTIME="var __slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1},__hasProp={}.hasOwnProperty,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};"}.call(this);